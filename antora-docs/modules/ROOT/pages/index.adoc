////
This content is automatically generated from a template, see
https://github.com/hacbs-contract/ec-policies/tree/main/docsrc
Do not edit it manually.
////

= HACBS Enterprise Contract Policies

:toc: left
:icons: font
:numbered:

== About

The HACBS Enterprise Contract is a Tekton task that can be used to verify the
provenence of container images built in HACBS and validate them against a set of
policies.

Those policies are defined using the
https://www.openpolicyagent.org/docs/latest/policy-language/[rego policy language]
and are described here.

== Pipeline Policy

These rules are applied to Tekton pipeline definitions.

=== Basic Rules

[#unexpected_kind]
==== link:#unexpected_kind[`unexpected_kind`] Input data has unexpected kind

A sanity check to confirm the input data has the kind "Pipeline"

* Path: `data.policy.pipeline.basic.deny`
* Failure message: `Unexpected kind '%s'`
* https://github.com/hacbs-contract/ec-policies/blob/main/policy/pipeline/basic.rego#L19[Source]

=== Pipeline Version Rules

[#pipeline_version_exists]
==== link:#pipeline_version_exists[`pipeline_version_exists`] Pipeline defines a version

The Pipeline has an explicitly defined version value. The version is
expected to be defined by the "app.kubernetes.io/version" resource label.

* Path: `data.policy.pipeline.pipeline_version.deny`
* Failure message: `Pipeline %q does not define a version`
* Effective from: `Sun, 01 Jan 2023 00:00:00 +0000`
* https://github.com/hacbs-contract/ec-policies/blob/main/policy/pipeline/pipeline_version.rego#L19[Source]

[#pipeline_version_format]
==== link:#pipeline_version_format[`pipeline_version_format`] Pipeline version must be in a specific format

The Pipeline version is expected to be in one of the following formats:
1
1.2
1.2.3

Each part of the version must have 1 or more digits. All other characters are
not allowed.

* Path: `data.policy.pipeline.pipeline_version.deny`
* Failure message: `Pipeline %q defines an invalid version format, %s. Use "." separated digits`
* Effective from: `Sun, 01 Jan 2023 00:00:00 +0000`
* https://github.com/hacbs-contract/ec-policies/blob/main/policy/pipeline/pipeline_version.rego#L43[Source]

[#pipeline_version]
==== link:#pipeline_version[`pipeline_version`] Pipeline version is outdated

The Pipeline version is expected to meet a minimum required version.

The minimum version are:

----
map[effective_on:2023-01-01T00:00:00Z version:0.5]
map[effective_on:2022-01-01T00:00:00Z version:0.4]
----

* Path: `data.policy.pipeline.pipeline_version.deny`
* Failure message: `Version of Pipeline %q is outdated, %s. Update to %s or newer`
* Effective from: `Sun, 01 Jan 2023 00:00:00 +0000`
* https://github.com/hacbs-contract/ec-policies/blob/main/policy/pipeline/pipeline_version.rego#L67[Source]

=== Required Tasks Rules

[#required_tasks]
==== link:#required_tasks[`required_tasks`] Pipeline does not include all required check tasks

Every build pipeline is expected to contain a set of checks and tests that
are required by the Enterprise Contract. This rule confirms that the pipeline
definition includes all the expected tasks.

The matching is done using the taskRef name rather than the pipeline task name.

The required task refs are:

----
clamav-scan
conftest-clair
get-clair-scan
sanity-inspect-image
sanity-label-check
sast-go
sast-java-sec-check
----

* Path: `data.policy.pipeline.required_tasks.deny`
* Failure message: `Required tasks %s were not found in the pipeline's task list`
* https://github.com/hacbs-contract/ec-policies/blob/main/policy/pipeline/required_tasks.rego#L32[Source]

== Release Policy

These rules are applied to pipeline run attestations associated with
container images built by HACBS.

=== Attestation Task Bundle Rules

[#disallowed_task_reference]
==== link:#disallowed_task_reference[`disallowed_task_reference`] Task bundle was not used or is not defined

Check for existence of a task bundle. Enforcing this rule will
fail the contract if the task is not called from a bundle.

* Path: `data.policy.release.attestation_task_bundle.warn`
* Failure message: `Task '%s' does not contain a bundle reference`
* https://github.com/hacbs-contract/ec-policies/blob/main/policy/release/attestation_task_bundle.rego#L14[Source]

[#disallowed_task_bundle]
==== link:#disallowed_task_bundle[`disallowed_task_bundle`] Task bundle was used that was disallowed

Check for existence of a valid task bundle. Enforcing this rule will
fail the contract if the task is not called using a valid bundle image.

The allowed bundles are:

----
quay.io/redhat-appstudio/build-templates-bundle
quay.io/redhat-appstudio/hacbs-templates-bundle
quay.io/redhat-appstudio/appstudio-tasks
----

* Path: `data.policy.release.attestation_task_bundle.warn`
* Failure message: `Task '%s' has disallowed bundle image '%s'`
* https://github.com/hacbs-contract/ec-policies/blob/main/policy/release/attestation_task_bundle.rego#L35[Source]

=== Attestation Type Rules

[#unknown_att_type]
==== link:#unknown_att_type[`unknown_att_type`] Unknown attestation type found

A sanity check that the attestation found for the image has the expected
attestation type. Currently there is only one attestation type supported,
`https://in-toto.io/Statement/v0.1`.

* Path: `data.policy.release.attestation_type.deny`
* Failure message: `Unknown attestation type '%s'`
* https://github.com/hacbs-contract/ec-policies/blob/main/policy/release/attestation_type.rego#L18[Source]

=== Not Useful Rules

[#bad_day]
==== link:#bad_day[`bad_day`] A dummy rule that always fails

It's expected this rule will be skipped by policy configuration.
This rule is for demonstration and test purposes and should be deleted soon.

* Path: `data.policy.release.not_useful.deny`
* Failure message: `It just feels like a bad day to do a release`
* Effective from: `Sat, 01 Jan 2022 00:00:00 +0000`
* https://github.com/hacbs-contract/ec-policies/blob/main/policy/release/not_useful.rego#L15[Source]

=== Step Image Registries Rules

[#disallowed_task_step_image]
==== link:#disallowed_task_step_image[`disallowed_task_step_image`] Task steps ran on container images that are disallowed

Enterprise Contract has a list of allowed registry prefixes. Each step in each
each TaskRun must run on a container image with a url that matches one of the
prefixes in the list.

The allowed registry prefixes are:

----
quay.io/redhat-appstudio/
registry.access.redhat.com/
registry.redhat.io/
----

* Path: `data.policy.release.step_image_registries.deny`
* Failure message: `Step %d in task '%s' has disallowed image ref '%s'`
* https://github.com/hacbs-contract/ec-policies/blob/main/policy/release/step_image_registries.rego#L20[Source]

=== Test Rules

[#test_data_missing]
==== link:#test_data_missing[`test_data_missing`] No test data found

None of the tasks in the pipeline included a HACBS_TEST_OUTPUT
task result, which is where Enterprise Contract expects to find
test result data.

* Path: `data.policy.release.test.deny`
* Failure message: `No test data found`
* https://github.com/hacbs-contract/ec-policies/blob/main/policy/release/test.rego#L15[Source]

[#test_results_missing]
==== link:#test_results_missing[`test_results_missing`] Test data is missing the results key

Each test result is expected to have a 'results' key. In at least
one of the HACBS_TEST_OUTPUT task results this key was not present.

* Path: `data.policy.release.test.deny`
* Failure message: `Found tests without results`
* https://github.com/hacbs-contract/ec-policies/blob/main/policy/release/test.rego#L29[Source]

[#test_result_failures]
==== link:#test_result_failures[`test_result_failures`] Some tests did not pass

Enterprise Contract requires that all the tests in the
test results have a result of 'SUCCESS'. This will fail if any
of the tests failed and the failure message will list the names
of the failing tests.

* Path: `data.policy.release.test.deny`
* Failure message: `The following tests did not complete successfully: %s`
* https://github.com/hacbs-contract/ec-policies/blob/main/policy/release/test.rego#L46[Source]

See Also
--------

* https://red-hat-hybrid-application-cloud-build-services-documentation.pages.redhat.com/hacbs-documentation/[HACBS Documentation]
* https://github.com/redhat-appstudio/build-definitions/blob/main/tasks/verify-enterprise-contract.yaml["Verify Enterprise Contract" task definition]
* https://github.com/hacbs-contract/ec-policies[github.com/hacbs-contract/ec-policies]
* https://github.com/hacbs-contract[github.com/hacbs-contract]
* https://github.com/redhat-appstudio[github.com/redhat-appstudio]
